A. 몽고디비 인덱스 사용법에 대한 학습

1. 인덱스를 사용해야 하는 이유

1) 인덱스를 활용하지 않는 경우

   - 하나의 조건을 find할 때에 모든 다큐먼트를 탐색하게 됨
   - 데이터가 만단위이면 큰 문제가 없으나, 십만, 백만 단위로 올라가는 순간 성능에 큰 문제가 생김

2) 인덱스를 활용하는 경우

   - 인덱스를 활용하면 특정 필드에 오름차순이나 내림차순 정렬을 적용할 수 있음
   - 그렇게 적용이 되는 순간, 이제 db 탐색 시에 마치 바이너리 서치와 비슷한 탐색을 진행하게 됨

---

2. 성능 비교를 위한 테스트: 1백만 개의 페이커 유저데이터를 만들어서 진행

1) 테스트 1

   - 조건: age가 30인 데이터를 find
   - 인덱스 미사용 결과 -> 750ms 소요, 1백만번 모두 탐색
   - 인덱스 사용 결과 -> 32ms 소요, 2049번 탐색

2) 테스트 2: 페이지네이션 실험

   - 조건 : age가 30 이상인 데이터 + skip 300000 & limit 30000으로 find
   - 인덱스 미사용 결과 -> 300ms 소요, 999145개 스캔해서, 30000개 스킵
   - 인덱스 사용 결과 -> 171ms 소요, 필요한 330000개만 스캔해서, 30000개 스킵
   - 페이지네이션의 원리는 전부 찾아서, 정렬하고 skip해서 limit까지만 뽑아내는 것인데, 인덱스를 사용하면 필요한 부분만 찾고 이미 정렬된 상태에서 skip, limit을 진행하여 굉장히 효율적이게 됨.
   - 페이지네이션 원리 자체가 앞페이지, 마지막페이지를 로딩할때 성능이 젤 우수하고 중간페이지 일수록 속도가 느려질 수 있음. 이유는 앞은 오름차순, 끝은 내림차순으로 정렬하여 보여주면 금방이지만, 중간 페이지는 스캔을 누적해서 해야하고 스킵도 많이할수밖에 없기 때문
   - 애초에 인덱스 자체가 무조건적으로 쓰여야한다기보단, 페이지네이션과 같은 특정 기능 구현시, 효율의 극대화를 위해 필요한 것 같다는 생각

---

3. 복합키(Compound Key)에 대한 학습

- 2개이상의 필드에 대해 index를 함께 적용하는 것을 복합키라 함. 가령 age 뿐만아니라 username도 사전식 정렬로 함께 적용하고 싶다면, index설정시 두 가지를 모두 add하여 설정해야함.
- 다만 설정한 순서에 맞게만 사용할 수 있음. 조건을 반대로 걸면 불가능.
- 또 다만, age를 오름차순(1), username을 내림차순(-1)으로 인덱스를 주었을 때, sort적용하여 find시, 서로의 값을 반대로(age에 -1, username에 1) 주어도 인덱스 적용이 가능함. 신기한 부분인데 이건 서로 대칭되기만 하면 적용된다고 생각하면 될듯.

---

4. 분포도(Selectivity)에 대한 학습

- lastname과 age에 각각 index를 걸고, 두 조건을 설정하여 find를 하면 두 개 중에 하나를 선택해서 탐색하게 됨
- 선택하는 기준은 mongoDB가 초반에 두가지 모두를 활용하여 탐색을 하다가, 더 탐색이 용이한 것이 무엇인지를 판단하여, 결국 하나를 선택해서 탐색을 완료하게 되는 거임. (두개를 함께 복합키로 설정한 인덱스를 만들더라도 마찬가지로 위 과정을 통해 선정을 진행함)
- 그렇다면 좋은 인덱스란 무엇인가? -> 분포도를 고려할 줄 아는 것임
- 분포도란 중복값이 얼마나 적게 존재하느냐를 뜻함. 가령 유저의 age는 무수히 다양할 수 있지만, 만약 혈액형이라는 걸 기준으로 한다면 혈액형은 4가지 밖에 존재하지 않기 때문에 중복값이 너무 많음. 이러한 것을 분포도가 안좋다고 말할 수 있음.
- 분포도가 안좋으면 mongoDB가 조건에 따라 데이터를 빠르게 좁히기가 어렵기 때문에 효율을 뽑아내기가 힘듦

---

5. 인덱스를 무작정 늘린다고 좋을까?

- no. 필요한 인덱스만 적절히 설정하는 것이 중요함.
- 이유 1. 인덱스는 그 자체로 용량을 상당히 먹음. 여러개의 인덱스가 있을 수록 db 용량이 기하급수적으로 늘어날수밖에 없음.
- 이유 2. Read의 성능은 좋아지지만, Create, Update, Delete의 성능은 안좋아질수밖에 없음. 이유는 생성할때마다 그에 해당하는 index에 데이터를 추가해줘야하고, Update도 마찬가지이며, Delete도 그에 맞는 것을 다 삭제해줘야함.

---

6. 총정리: 인덱스 사용법

- CUD vs R: 을 고려하여 인덱스를 적절히 만들어야 함. 예를 들어 해당 콜렉션이 읽기비중이 확실히 높을때 써야함
- memory: 많이 먹기 때문에 무조건적으로 늘리면 안됨
- query: 어떤 형식으로 쿼리를 날리는 지를 체크하여 그에 맞게 설정해야함
- selectivity: 분포도가 높은 것(중복이 적고 다양하게 분포할 때)들 위주로 인덱스를 사용해야 함
